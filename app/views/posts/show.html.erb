<% content_for :page_title, "#{ @post.title }" %>
<% begin %><% content_for :og_image, "#{ polymorphic_url(@ordered_images.first.variant(quality: 95).processed) if @ordered_images.present? && @ordered_images.any? }" %><% rescue %><% end %>
<% content_for :og_description, strip_tags(markdown(@post.description || "")).truncate(200).gsub("\n"," ") %>
<% content_for :bg_large, "true" if @ordered_images.present? || @post.carousel_video.present? %>

<article class="<%= "pt-1/8 sm:pt-1/2" unless @ordered_images.present? || @post.carousel_video.present? %>">
  <div class="item item--single <%= "mt-1/1" unless @ordered_images.present? || @post.carousel_video.present? %>">
    <h1 class="item__title <%= @ordered_images.present? || @post.carousel_video.present? ? "text-black" : "text-pure-white" %>">
      <%= @post.title %>

      <%= render "favorites/form", post: @post %>
    </h1>

    <div class="item__code" data-action="copy-to-clipboard" data-target="<%= @post.code %>">
      <%= inline_svg_tag "icons/icon-copy.svg", class: "copy-trigger" %>

      <span class="copy">
        <span data-copy="<%= @post.code %>" data-track-copy><%= @post.code %></span>
      </span>
    </div>
  </div>

  <% if @is_expired %>
    <div class="well well--dark block warning mt-1/4 mb-1/4 pt-1/8 pb-1/8">
      <p class="mb-0">‚ö† <mark><%= t(".expired.title") %></mark></p>
      <p class="mt-0"><small><%= t(".expired.content") %></small></p>
    </div>
  <% end %>

  <% cache_unless current_user && current_user == @post.user, [current_locale, @post, "show"] do %>
    <% if current_user == @post.user %>
      <div class="well well--dark mb-1/2" data-toggle-content>
        <div>
          <%= link_to "Edit", edit_post_path(@post.code), class: "mr-1/4" %>
          <%= tag.span "Analytics", class: "mr-1/1 text-white cursor-pointer", data: { action: "toggle-content reveal-post-analytics", id: @post.id } %>
          <%= link_to "Delete", post_path(@post.code), class: "text-red", method: :delete, data: { confirm: "Are you sure you want to delete this code? This cannot be undone. \n\n This will delete code: \n #{ @post.code } \n\n With title: \n #{ @post.title }" } %>
        </div>

        <div class="well__tray" data-role="content-to-toggle" style="display: none">
          <%= render "posts/analytics", post: @post %>
        </div>
      </div>

      <% if @post.private? %>
        <div class="warning warning--mild well well--dark block mt-0 mb-1/2">
          <p class="mb-0 mt-0 text-white">üîê <%= t(".private.title") %></p>
          <p class="mt-0 mb-0"><small><%= t(".private.content") %></small></p>
        </div>
      <% end %>

      <% if @post.unlisted? %>
        <div class="warning warning--mild well well--dark block mt-0 mb-1/2">
          <p class="mb-0 text-white mt-0">üìÉ <%= t(".unlisted") %></p>
        </div>
      <% end %>

      <% if @post.updated_at > 6.months.ago && @post.updated_at < 5.months.ago %>
        <div class="warning mt-1/4">
          <p><mark>‚ö† <%= t(".expire_soon.title") %></mark></p>
          <%= t(".expire_soon.content_html", time: time_ago_in_words(@post.updated_at + 6.months)) %>
        </div>
      <% end %>
    <% end %>

    <% begin %>
      <% if @ordered_images.present? && @ordered_images.one? && !@post.carousel_video.present? %>
        <picture>
          <source media="(min-width: 560px)" srcset="<%= url_for @ordered_images.first.variant(quality: 95).processed %>" type="image/jpeg">
          <source media="(min-width: 0px)" srcset="<%= url_for @ordered_images.first.variant(quality: 95, resize_to_fill: [450, 250]).processed %>" type="image/jpeg">
          <img class="img-fluid" src="<%= url_for @ordered_images.first.variant(quality: 95).processed %>" />
        </picture>
      <% elsif (@ordered_images.present? && @ordered_images.many?) || (@post.carousel_video.present? && @ordered_images.present?) %>
        <%= render "carousel" if @post.images.any? %>
      <% elsif !@ordered_images.present? && @post.carousel_video.present? %>
        <div>
          <%= render "carousel_video" %>
        </div>
      <% end %>
    <% rescue %>
      <p><small><em>Images are temporarily unavailable.</em></small></p>
    <% end %>

    <div class="item__description">
      <%= sanitized_markdown(@post.description) %>
    </div>

    <%= render "posts/snippet" if @post.snippet.present? %>

    <div class="item item--bottom">
      <div class="item__details">
        <%= render "profiles/profile", user: @post.user, small: true %>

        <div class="well well--dark block">
          <div class="item__details-item">
            <%= t(".categories") %> |

            <% @post.categories.each do |category| %>
              <%= link_to i18n_value_in_array(categories, category), filter_path(category: to_slug(category)) %><%= "," unless category == @post.categories.last %>
            <% end %>
          </div>

          <% if @post.tags.present? %>
            <div class="item__details-item">
              <%= t(".tags") %> |

              <% @post.tags.tr("[]", "").split(/,\s*/).each do |tag| %>
                <%= link_to tag.downcase, filter_path(search: tag.downcase), class: "tag" %>
              <% end %>
            </div>
          <% end %>

          <div class="item__details-item">
            <%= t(".heroes") %> |

            <% if @post.heroes.length == heroes.length %>
              <%= t(".all") %>
            <% else %>
              <% @post.heroes.each do |hero| %>
                <%= link_to i18n_value_in_array(heroes, hero), filter_path(hero: to_slug(hero)) %><%= "," unless hero == @post.heroes.last %>
              <% end %>
            <% end %>
          </div>

          <div class="item__details-item">
            <%= t(".maps") %> |

            <% if @post.maps.length == maps.length %>
              <%= t(".all") %>
            <% else %>
              <% @post.maps.each do |map| %>
                <%= link_to i18n_value_in_array(maps, map), filter_path(map: to_slug(map)) %><%= "," unless map == @post.maps.last %>
              <% end %>
            <% end %>
          </div>

          <div class="item__details-item" title="Created at: <%= @post.created_at %>">
            <%= t(".created_at") %> |

            <span data-role="timeago" datetime="<%= @post.created_at %>"></span>
          </div>

          <div class="item__details-item" title="Updated at: <%= @post.updated_at %>">
            <%= t(".updated_at") %> |

            <time data-role="timeago" datetime="<%= @post.updated_at %>"></time>
          </div>

          <% if @post.version.present? %>
            <div class="item__details-item">
              <%= t(".version") %> |

              <%= @post.version %>
            </div>
          <% end %>

          <% if @post.nice_url.present? %>
            <div class="item__details-item">
              <%= t(".nice_url") %> |

              <%= link_to nice_url_url(@post.nice_url), nice_url_path(@post.nice_url) %>
            </div>
          <% end %>

          <div class="item__details-item">
            <%= link_to t("report.action"), new_report_path(id: @post.id), class: "text-red", remote: true, data: { disable_with: t("report.loading") } %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</article>

<% cache_unless current_user, [current_locale, @post.collection, @post.comments, @revisions] do %>
  <%= render "collections/collections" if @post.collection && @post.collection.posts.public?.many? %>

  <div class="comments" id="comments">
    <div class="heading items-heading mb-1/2">
      <h2 class="mt-0 mb-0"><span data-role="comment-total"><%= @post.comments.count %></span> <%= t("comments.title") %></h2>
    </div>

    <%= render "comments/form", post: @post %>

    <div class="comments__wrapper" data-role="comments">
        <%= render @post.comments.where(parent_id: nil).order(created_at: :desc) %>
    </div>
  </div>

  <%= render "revisions/revisions" if @revisions.size > 1 %>
<% end %>
